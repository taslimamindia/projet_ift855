name: Deploy Frontend to S3 + CloudFront in prod.

on:
  # Trigger only when a PR targeting main is closed
  pull_request:
    types: [closed]
    branches:
      - main
      
  # Allow manual trigger
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # Validate trigger conditions
      - name: Validate trigger conditions
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            if [ "${{ github.event.pull_request.merged }}" != "true" ]; then
              echo "Error: PR was closed but not merged. Failing..."
              exit 1
            fi
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "Manual trigger detected."
          else
            echo "Error: Invalid trigger event: ${{ github.event_name }}"
            exit 1
          fi
          echo "Trigger conditions satisfied."
      
      # --- Checkout repository ---
      - name: Checkout repository
        uses: actions/checkout@v4

      # --- Setup Node.js ---
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      # --- Check required environment variables ---
      - name: Check required environment variables
        run: |
          REQUIRED_VARS=(
            "AWS_REGION"
            "AWS_ACCESS_KEY_ID"
            "AWS_SECRET_ACCESS_KEY"
            "AWS_S3_BUCKET_NAME"
            "AWS_CLOUDFRONT_DISTRIBUTION_ID"
            "VITE_BACKEND_API_URL"
            "VITE_BACKEND_API_URL_WS"
            "VITE_ADMIN_PASSWORD"
          )
          for var in "${REQUIRED_VARS[@]}"; do
            if [ -z "${!var:-}" ]; then
              echo "Error: variable $var is not defined."
              exit 1
            fi
          done
          echo "âœ… All required environment variables are available."
        env:
          AWS_REGION: ${{ secrets.AWS_REGION }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_S3_BUCKET_NAME: ${{ secrets.AWS_S3_BUCKET_NAME }}
          AWS_CLOUDFRONT_DISTRIBUTION_ID: ${{ secrets.AWS_CLOUDFRONT_DISTRIBUTION_ID }}
          VITE_BACKEND_API_URL: ${{ secrets.VITE_BACKEND_API_URL }}
          VITE_BACKEND_API_URL_WS: ${{ secrets.VITE_BACKEND_API_URL_WS }}
          VITE_ADMIN_PASSWORD: ${{ secrets.VITE_ADMIN_PASSWORD }}

      # --- Install dependencies ---
      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci || npm install

      # --- Build project with Vite environment variables ---
      - name: Build project
        working-directory: ./frontend
        run: npm run build
        env:
          VITE_BACKEND_API_URL: ${{ secrets.VITE_BACKEND_API_URL }}
          VITE_BACKEND_API_URL_WS: ${{ secrets.VITE_BACKEND_API_URL_WS }}

      # --- Configure AWS credentials ---
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # --- Deploy frontend to S3 ---
      - name: Deploy to S3
        run: |
          aws s3 sync frontend/dist/ "s3://${{ secrets.AWS_S3_BUCKET_NAME }}" --delete

      # --- Invalidate CloudFront cache ---
      - name: Invalidate CloudFront cache
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ secrets.AWS_CLOUDFRONT_DISTRIBUTION_ID }} \
            --paths "/*"
